<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>e-Tool</title>
  <script src="script.js"></script>
  <style>
	body {
		font-family: 'Courier New';
		background: #f4f6f8;
		color: #222;
		max-width: 1150px;
		margin: 30px auto 0 auto;
		padding: 30px 25px 25px 25px;
		border-radius: 18px;
		box-shadow: 0 10px 32px rgba(60,72,90,0.12), 0 2px 8px rgba(0,0,0,0.04);
	}

	#header {

		font-family: 'Georgia';
		background: #26a69a;
		color: #FFF;
		margin-top:-40px;
		margin-left:-25px;
		margin-right:-25px;
		margin-bottom: 25px;
		border-top-left-radius: 18px;
		border-top-right-radius: 18px;
		padding: 10px 10px;
		box-shadow: 0 10px 32px rgba(60,72,90,0.12), 0 2px 8px rgba(0,0,0,0.04);
	}
    .tabs {
      display: flex;
    }

    .tab {
      padding: 8px 8px;
      cursor: pointer;
      margin-right: 5px;
      border: 1px solid transparent;
      border-bottom: none;
	  <!--border-radius: 5px;-->
    }

    .tab.active {
      border: 1px solid #26a69a;
      border-bottom: 1px solid #26a69a;
      background-color: #26a69a; <!--26a69a;-->
      font-weight: bold;
	  border-bottom: none;
	  border-top-left-radius: 8px;
	  border-top-right-radius: 8px;
	  color: #FFF;
    }

    .tab-content {
      display: none;
      padding: 20px;
      border: 1px solid #26a69a;
	  border-bottom-right-radius: 18px;
	  border-bottom-left-radius: 18px;
    }

    .tab-content.active {
      display: block;
    }
	h1 {
		text-align: center;
		font-size: 2.1em;
		letter-spacing: 1px;
		margin-bottom: 32px;
	}
	#controls {
		display: flex;
		flex-wrap: wrap;
		gap: 15px;
		justify-content: center;
		margin-bottom: 15px;
		margin-top: 8px;
	}

	#count {
		text-align: center;
		margin: 18px 0 10px 0;
		font-size: 1.08em;
		font-weight: bold;
		letter-spacing: 0.2px;
		color: #0066ff;
	}
	textarea:focus {
		border: 1.5px solid #0066ff;
		outline: none;
	}

	#dropzone{
		border: 2px dashed #aaa;
		border-radius: 10px;
		padding: 30px;
		margin: 20px auto;
		width: 94%;
		background: #fafafa;
		color: #444;
		transition: 0.3s all;
	}

	#output{
	
		width: 100%;
		height: 400px;
		font-size: 1em;
		line-height: 1.5;
		background: #fff;
		border: 1.5px solid #c7d0df;
		border-radius: 8px;
		padding: 30px 30px;
		resize: vertical;
		margin-top: 8px;
		box-sizing: border-box;
		field-sizing: content;
		transition: border 0.14s;
	
	}
	
	#inputEmail, #outputEmail{
		
		width: 100%;
		height: 243px;
		font-size: 1em;
		line-height: 1.5;
		background: #fff;
		border: 1.5px solid #c7d0df;
		border-radius: 8px;
		padding: 30px 30px;
		resize: vertical;
		margin-top: 8px;
		box-sizing: border-box;
		field-sizing: content;
		transition: border 0.14s;
	}
	
	.btn {
		border-width: 0;
		padding: 10px 14px;
		outline: 0 !important;
		background-image: none !important;
		filter: none;
		-webkit-box-shadow: none;
		-moz-box-shadow: none;
		box-shadow: none;
		text-shadow: none;
	}
	
	.btn-sm, .btn-sm {
		padding: 10px 10px 10px;
		font-size: 15px;
		line-height: 1.5;
		border-radius: 8px;
		cursor: pointer;
	}
	.green.btn{
		color: #FFF;
		background-color: #26a69a;
	}
	

	.green:hover {
		 background-color: #00c9b7;
	}


  </style>
</head>
<body id="fullbody">

	<div id="header">
		<center><h2><b>SRC-EML Management Tool</b></h2></center>
	</div>
	<hr style="margin-bottom:15px;">
	
	<div class="tabs">
	  <div class="tab active" onclick="showTab('Extractor')">Source Extractor</div>
	  <div class="tab" onclick="showTab('Generator')">Repo-News Generator</div>
	</div>

	<div id="Extractor" class="tab-content active">
  
		<div id="dropzone" class="">
		  <center><span id="dropLabel">Drop your .eml file here</span></center>
		</div>
		<div id="controls">
			<button class="btn btn-sm green" onclick="extractHtmlParts('html')">Extract HTML (QP)</button>
			<button class="btn btn-sm green" onclick="extractPlainParts()">Extract Plain Text (QP)</button>
			<button class="btn btn-sm green" onclick="extractHeaders()">Extract Headers</button>
			<button class="btn btn-sm green" onclick="copyNegatives()">Copy Result</button>
			<button class="btn btn-sm green" onclick="downloadResult()">
			
			<svg xmlns="http://www.w3.org/2000/svg" width="18" height="20" fill="currentColor" class="bi bi-file-earmark-arrow-down-fill" viewBox="0 0 13 12">
				<path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1m-1 4v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 11.293V7.5a.5.5 0 0 1 1 0"/>
			</svg> Download Results as TXT</button>
		</div>
		
		<div id="counter" style="margin-top: 10px; font-weight: bold; color: #26a69a;"></div>
		
		<textarea id="output" readonly></textarea>
	  
	</div>

	<div id="Generator" class="tab-content">
		<textarea id="inputEmail" placeholder="Paste your email source here"></textarea><br><br>
		<div id="controls">
			<button class="btn btn-sm green" onclick="processEmail()">Generate News</button>
			<button class="btn btn-sm green" onclick="copyToClipboard()">Copy News</button>
		</div>
		
		<textarea id="outputEmail" readonly placeholder="Processed output will appear here"></textarea>

	</div>



<script>
	let emlContent = '';


	const fullbody  = document.getElementById('fullbody');
	const dropzone  = document.getElementById('dropzone');
	const dropLabel = document.getElementById('dropLabel');
	

	fullbody.style.height = output.offsetHeight+90;
	
	function showTab(id) {
		document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
		document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
		document.querySelector(`.tab[onclick*="${id}"]`).classList.add('active');
		document.getElementById(id).classList.add('active');
	}

	dropzone.addEventListener('dragover', function(e) {
	  e.preventDefault();
	  dropzone.style.background = '#e3f2fd';
	  dropLabel.innerHTML = 'Release to load the file';
	});

	dropzone.addEventListener('dragleave', function(e) {
	  e.preventDefault();
	  dropzone.style.background = '#fafafa';
	  dropLabel.innerHTML = 'Drop your .eml file here';
	});

	dropzone.addEventListener('drop', function(e) {
	  document.getElementById('counter').innerHTML = '';
	  e.preventDefault();
	  dropzone.style.background = '#dff0d8';
	  dropzone.style.color = '#3c763d';

	  const file = e.dataTransfer.files[0];
	  if (!file || !file.name.endsWith('.eml')) {
		dropLabel.innerHTML = 'Invalid file. Please drop a .eml file.';
		return;
	  }

	  const reader = new FileReader();
	  reader.onload = function(event) {
		emlContent = event.target.result;
		dropLabel.innerHTML = `File loaded: ${file.name}`;
		document.getElementById('output').value = 'File loaded via drag & drop. Choose an action.';
	  };
	  reader.readAsText(file);
	});

	function extractPlainParts() {
	
		const outputEmail = document.getElementById('output');

		outputEmail.style.background = '#fff';
		outputEmail.style.color = '#222';

	
		if (!emlContent) {
				dropzone.style.background = '#ebccd1';
				dropzone.style.color = '#a94442';
				dropLabel.innerHTML = 'You Must Drop your .eml file here !';
			return;
		}
		const contentType = 'text/plain';
		
		const file = emlContent;
		const lines = file.split(/\r?\n/);
		const sources = [];
		const sourcex = [];
		let foundTotal = 0;

		for (let i = 0; i < lines.length; i++) {
		
			if (lines[i].trim().toLowerCase().startsWith('content-type:') &&
				lines[i].toLowerCase().includes(contentType)) {

				// Look forward for Content-Transfer-Encoding: base64 until next boundary or blank line
				let hasBase64 = false;
				let headerEnd = -1;
				for (let j = i + 1; j < lines.length; j++) {
					if (/^--/.test(lines[j])) break; // hit a boundary, stop
					if (lines[j].trim() === "") { headerEnd = j; break; }
					if (/^Content-Transfer-Encoding:\s*base64\b/i.test(lines[j].trim())) hasBase64 = true;
				}

			if (headerEnd !== -1) {
				foundTotal++;
				if (hasBase64) {
					// Gather base64 content until next boundary or another header or empty line
					let base64Lines = [];
					for (let k = headerEnd + 1; k < lines.length; k++) {
						if (/^--/.test(lines[k])) break;
						if (lines[k].trim() === "") break;
						base64Lines.push(lines[k]);
					}
					const base64str = base64Lines.join("");
					try {
						const decoded = atob(base64str.replace(/\s/g, ""));
						sources.push(decoded);
					} catch (e) {
						// Ignore decode errors, skip this block
					}
				} else {
					// Not base64, treat as plain text or html
					let partLines = [];
					for (let k = headerEnd + 1; k < lines.length; k++) {
						if (/^--/.test(lines[k])) break;
						if (lines[k].trim().toLowerCase().startsWith('content-type:')) break;
						partLines.push(lines[k]);
					}
					const partStr = partLines.join("\n");
					sources.push(partStr);
				}
			}
			}}
		sources.splice(0,1);
		const joined = sources.join('\n__SEP__\n\n');
		document.getElementById('output').value = joined;

		// Show count
		document.getElementById('counter').innerHTML = `✅ Found ${sources.length} PLAIN part(s)`;
		return;
	}
	
	function extractHtmlParts() {
		const outputEmail = document.getElementById('output');

		outputEmail.style.background = '#fff';
		outputEmail.style.color = '#222';

		const type = 'html';

		if (!emlContent) {
			dropzone.style.background = '#ebccd1';
			dropzone.style.color = '#a94442';
			dropLabel.innerHTML = 'You Must Drop your .eml file here !';
		return;
		}

		// Match all relevant MIME parts
		const regex = new RegExp(
		`Content-Type:\\s*text\\/${type}[^]*?Content-Transfer-Encoding:\\s*(base64|quoted-printable)[^]*?\r?\n\r?\n([\\s\\S]*?)(?:\r?\n--|$)`,
		'gi'
		);

		const matches = [...emlContent.matchAll(regex)];
		if (matches.length === 0) {
		document.getElementById('output').value = `No ${type} parts with base64 or quoted-printable found.`;
		return;
		}

		const decodedParts = matches.map(match => {
		const encoding = match[1].toLowerCase().trim();
		let raw = match[2].trim();

		if (encoding === 'base64') {
		  try {
			const decoded = atob(raw.replace(/\r?\n/g, ''));
			return toQuotedPrintable(decoded);
		  } catch (e) {
			return '[Invalid base64]';
		  }
		} else if (encoding === 'quoted-printable') {
		  return toQuotedPrintable(qpDecode(raw));
		} else {
		  return '[Unsupported encoding]';
		}
		});

		const joined = decodedParts.join('\n__SEP__\n\n');
		document.getElementById('output').value = joined;

		// Show count
		document.getElementById('counter').innerHTML = `✅ Found ${decodedParts.length} ${type.toUpperCase()} part(s)`;
	}


	function extractHeaders(){
		const outputEmail = document.getElementById('output');

		outputEmail.style.background = '#fff';
		outputEmail.style.color = '#222';
	
		if (!emlContent) {
			dropzone.style.background = '#ebccd1';
			dropzone.style.color = '#a94442';
			dropLabel.innerHTML = 'You Must Drop your .eml file here !';
		return;
		}

		const file = emlContent;
		const lines = file.split(/\r?\n/);
		const sources = [];
		let foundTotal = 0;

		// Extract all header blocks starting with Delivered-To and ending at the next empty line
		for (let i = 0; i < lines.length; i++) {
			if (lines[i].trim().toLowerCase().startsWith('delivered-to')) {
				let headerLines = [];
				let j = i;
				while (j < lines.length && lines[j].trim() !== '') {
					headerLines.push(lines[j]);
					j++;
				}
				sources.push(headerLines.join('\n'));
				foundTotal++;
				i = j; // move i to just after the blank line to continue searching
			}
		}
		
		const joined = sources.join('\n__SEP__\n\n');
		document.getElementById('output').value = joined;

		// Show count
		document.getElementById('counter').innerHTML = `✅ Found ${sources.length} HEADER part(s)`;
		return; 
	}


	function copyNegatives() {
	
		const Negative  = document.getElementById('output')
		const Negatives_tocopy = Negative.value;
		if (emlContent) {
			navigator.clipboard.writeText(Negatives_tocopy).then(() => {
			Negative.style.background = '#dff0d8';
			Negative.style.color = '#3c763d';

			}).catch(err => {
			Negative.style.background = '#ebccd1';
			Negative.style.color = '#a94442';
			});
			return;
		}
		else{
			Negative.style.background = '#ebccd1';
			Negative.style.color = '#a94442';
			dropzone.style.background = '#ebccd1';
			dropzone.style.color = '#a94442';
			dropLabel.innerHTML = 'No thing to copy !';
		return;
		}
	}
	function downloadResult() {
	
		const outputEmail = document.getElementById('output');

		outputEmail.style.background = '#fff';
		outputEmail.style.color = '#222';
		
	  const text = document.getElementById('output').value;
	  
	  if (!emlContent) {
			dropzone.style.background = '#ebccd1';
			dropzone.style.color = '#a94442';
			dropLabel.innerHTML = 'You Must Extract your parts !';
		return;
		}
		
	  const blob = new Blob([text], { type: 'text/plain' });
	  const link = document.createElement('a');
	  link.href = URL.createObjectURL(blob);
	  link.download = 'extracted_parts.txt';
	  link.click();
	}

	// --- Quoted-Printable Encoding ---
	function toQuotedPrintable(str) {
	  return str
		.replace(/[\t\x20]$/gm, (s) => s.split('').map(c => `=${c.charCodeAt(0).toString(16).toUpperCase().padStart(2, '0')}`).join(''))
		.replace(/[^!-<>-~\r\n\t ]/g, (c) =>
		  '=' + c.charCodeAt(0).toString(16).toUpperCase().padStart(2, '0')
		)
		.replace(/.{73}/g, '$&=\r\n');
	}

	// --- Quoted-Printable Decoding ---
	function qpDecode(str) {
	  return str
		.replace(/=\r?\n/g, '') // soft line breaks
		.replace(/=([A-Fa-f0-9]{2})/g, (match, hex) =>
		  String.fromCharCode(parseInt(hex, 16))
		);
	}
	
	function processEmail() {
            const input = document.getElementById('inputEmail').value;
            const outputEmail = document.getElementById('outputEmail');
			
			outputEmail.style.background = '#fff';
			outputEmail.style.color = '#222';
		
            let lines = input.split('\n');
            let outputLines = [];
            let inHeader = true;
            let boundary = '';
            let currentHeader = [];
            let hasListUnsubscribe = false;
            
            // Extract boundary from Content-Type
            const contentTypeMatch = input.match(/boundary=["']?([^"'\s]+)["']?/);
            if (contentTypeMatch) {
                boundary = contentTypeMatch[1];
            }

            // Fields to remove completely
            const fieldsToRemove = [
                'Delivered-To:',
                'Received: by',
                'X-Google-Smtp-Source:',
                'X-Received:',
                'ARC-Seal:',
                'ARC-Message-Signature:',
                'ARC-Authentication-Results:',
                'Return-Path:',
                'Received-SPF:',
                'Authentication-Results:',
                'DKIM-Signature:',
                'X-SG-EID:',
                'X-Entity-ID:'
            ];

            // Process each line
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trimEnd();
                
                // Check for boundary if present
                if (boundary && line.startsWith('--') && line.includes(boundary)) {
                    inHeader = false;
                    outputLines.push(line);
                    continue;
                }

                // Check for end of headers (empty line after headers)
                if (inHeader && line === '' && outputLines.length > 0) {
                    inHeader = false;
                    outputLines.push(''); // Preserve the empty line
                    continue;
                }

                if (inHeader) {
                    if (fieldsToRemove.some(field => line.startsWith(field))) {
                        continue;
                    }

                    if (line.startsWith('Received: from')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        currentHeader.push(line);
                        while (i + 1 < lines.length && 
                               (lines[i + 1].startsWith('\t') || lines[i + 1].startsWith(' '))) {
                            i++;
                            currentHeader.push(lines[i].trimEnd());
                        }
                    }
                    else if (line.startsWith('Date:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        outputLines.push('Date: [D=>%a, %d %b %Y %H:%M:%S] +0000');
                    }
                    else if (line.startsWith('To:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        outputLines.push('To: [*to]');
                    }
                    else if (line.startsWith('From:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        const fromMatch = line.match(/From:\s*(?:"([^"]*)"|([^<]*))\s*<(.+?)>/);
                        if (fromMatch) {
                            const namePart = (fromMatch[1] || fromMatch[2] || '').trim();
                            const email = fromMatch[3];
                            let cleanName = namePart;
                            
                            // If name part contains '@', extract second-level domain
                            if (namePart.includes('@')) {
                                const domainPart = namePart.split('@')[1] || '';
                                if (domainPart.includes('.')) {
                                    const domainParts = domainPart.split('.');
                                    cleanName = domainParts[domainParts.length - 2]; // Take second-level domain
                                } else {
                                    cleanName = domainPart;
                                }
                            }
                            // If name part contains '.' but no '@', treat as domain and remove TLD
                            else if (namePart.includes('.')) {
                                const domainParts = namePart.split('.');
                                cleanName = domainParts[domainParts.length - 2]; // Take second-level domain
                            }
                            
                            // Capitalize first letter
                            if (cleanName) {
                                cleanName = cleanName.charAt(0).toUpperCase() + cleanName.slice(1);
                            }
                            
                            // If no valid name after processing, use fallback
                            if (!cleanName) {
                                cleanName = 'Unknown';
                            }
                            
                            outputLines.push(`From: "${cleanName}" <[USER]@[P_RPATH]>`);
                        } else {
                            outputLines.push('From: "" <[USER]@[P_RPATH]>');
                        }
                    }
                    else if (line.toLowerCase().startsWith('message-id:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        const msgId = line.replace(/Message-Id:/i, '').trim();
                        if (!msgId.includes('[EID]')) {
                            const atIndex = msgId.indexOf('@');
                            if (atIndex !== -1) {
                                const localPart = msgId.substring(0, atIndex);
                                const domainPart = msgId.substring(atIndex);
                                const middleIndex = Math.floor(localPart.length / 2);
                                const newLocalPart = localPart.substring(0, middleIndex) + '[EID]' + 
                                                  localPart.substring(middleIndex);
                                outputLines.push(`Message-ID: ${newLocalPart}${domainPart}`);
                            } else {
                                const middleIndex = Math.floor(msgId.length / 2);
                                outputLines.push(`Message-ID: ${msgId.substring(0, middleIndex)}[EID]${msgId.substring(middleIndex)}`);
                            }
                        } else {
                            outputLines.push(`Message-ID: ${msgId}`);
                        }
                    }
                    else if (line.startsWith('List-Unsubscribe:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        outputLines.push('List-Unsubscribe: <mailto:unsubscribe@[P_RPATH]>, <http://[P_RPATH]/[OPTDOWN]>');
                        hasListUnsubscribe = true;
                    }
                    else if (line.startsWith('Content-Type:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        outputLines.push(line);
                        while (i + 1 < lines.length && 
                               (lines[i + 1].startsWith('\t') || lines[i + 1].startsWith(' '))) {
                            i++;
                            outputLines.push(lines[i].trimEnd());
                        }
                    }
                    else if (line.startsWith('MIME-Version:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        outputLines.push(line);
                    }
                    else if (line.startsWith('Subject:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        outputLines.push(line);
                    }
                    else if (line.startsWith('List-Unsubscribe-Post:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                    }
                    else if (line.startsWith('Reply-To:') || 
                           line.startsWith('Feedback-ID:') || 
                           line.startsWith('X-SES-Outgoing:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        outputLines.push(line);
                    }
                    else if (line.startsWith('Content-Transfer-Encoding:')) {
                        if (currentHeader.length > 0) {
                            outputLines.push(...currentHeader);
                            currentHeader = [];
                        }
                        outputLines.push(line);
                    }
                } else {
                    outputLines.push(line); // Preserve all body content
                }
            }

            if (currentHeader.length > 0) {
                outputLines.push(...currentHeader);
            }

            // Add Sender field after From field
            const fromIndex = outputLines.findIndex(line => line.startsWith('From:'));
            if (fromIndex !== -1) {
                outputLines.splice(fromIndex + 1, 0, 'Sender: [USER]@[P_RPATH]');
            }

            // Ensure List-Unsubscribe and List-Unsubscribe-Post are present
            if (!hasListUnsubscribe) {
                const insertIndex = outputLines.findIndex(line => line.startsWith('Sender:')) + 1 || fromIndex + 1;
                outputLines.splice(insertIndex, 0, 
                    'List-Unsubscribe: <mailto:unsubscribe@[P_RPATH]>, <http://[P_RPATH]/[OPTDOWN]>',
                    'List-Unsubscribe-Post: List-Unsubscribe=One-Click'
                );
            } else {
                const listUnsubIndex = outputLines.findIndex(line => line.startsWith('List-Unsubscribe:'));
                outputLines.splice(listUnsubIndex + 1, 0, 
                    'List-Unsubscribe-Post: List-Unsubscribe=One-Click'
                );
            }

            document.getElementById('outputEmail').value = outputLines.join('\n');
        }
		
	function copyToClipboard() {
	
		const outputEmail  = document.getElementById('outputEmail')
		const ouput_tocopy = outputEmail.value;
		
		if (ouput_tocopy) {
			navigator.clipboard.writeText(ouput_tocopy).then(() => {
			outputEmail.style.background = '#dff0d8';
			outputEmail.style.color = '#3c763d';

			}).catch(err => {
			outputEmail.style.background = '#ebccd1';
			outputEmail.style.color = '#a94442';
			});
			return;
		}
		else{
			outputEmail.style.background = '#ebccd1';
			outputEmail.style.color = '#a94442';
			
			
			
			outputEmail.placeholder = 'No thing to copy !';
		
		}
	}
</script>

</body>
</html>
